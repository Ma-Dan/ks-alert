package metric

import (
	"fmt"
	"testing"
)

func TestGetResourceTimeRangeMetric(t *testing.T) {
	Convey("test extract metric value", t, func() {
		Convey("test extract metric value01", func() {
			metricStr := `{"metrics_level":"node","results":[{"metric_name":"node_cpu_utilisation","status":"success","data":{"result":[{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.73"}],"resource_name":"i-ai2p6j3y"},"value":[1546838829.26,"0.4841249999997672"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.74"}],"resource_name":"i-rgem3qkr"},"value":[1546838829.26,"0.1482499999925495"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.57"}],"resource_name":"i-6soe9zl1"},"value":[1546838829.26,"0.12238962683965449"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.53"}],"resource_name":"i-76v18j2o"},"value":[1546838829.26,"0.11956865947455353"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.55"}],"resource_name":"i-5xcldxos"},"value":[1546838829.26,"0.09124999999912697"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.56"}],"resource_name":"i-e8oiua90"},"value":[1546838829.26,"0.09095833333364378"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.52"}],"resource_name":"i-wo83nj02"},"value":[1546838829.26,"0.08504166666728752"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.18"}],"resource_name":"i-8q3txahx"},"value":[1546838829.26,"0.0842500000008537"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.14"}],"resource_name":"i-gddrhbxs"},"value":[1546838829.26,"0.07549999999852541"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.62"}],"resource_name":"i-3jrrsg9r"},"value":[1546838829.26,"0.07362499999871941"]},{"metric":{"address":[{"type":"InternalIP","address":"192.168.0.67"}],"resource_name":"i-1abu8ksg"},"value":[1546838829.26,"0.060541666665812954"]}],"resultType":"vector"}}]}`
			res := GetResourceTimeSeriesMetric(metricStr, "node_cpu_utilisation")
			fmt.Println(res)
		})

		Convey("test extract metric value02", func() {
			metricStr := `{"metrics_level":"pod","results":[{"metric_name":"pod_net_bytes_transmitted","status":"success","data":{"result":[{"metric":{"node":"i-5xcldxos","resource_name":"csi-qingcloud-node-q7np4"},"values":[[1546839600,"28016.266937782297"],[1546839720,"51324.066666666666"],[1546839840,"29519.716666666667"],[1546839960,"32725.85"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-9x7kr"},"values":[[1546839600,"0"],[1546839720,"0"],[1546839840,"0"],[1546839960,"0"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-zcrw8"},"values":[[1546839600,"8370.189503158386"],[1546839720,"8378.2"],[1546839840,"5730.716666666666"],[1546839960,"4051.5333333333333"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apigateway-6d9d4889bb-8d5wc"},"values":[[1546839600,"101.35168919481991"],[1546839720,"1848.4333333333334"],[1546839840,"854.55"],[1546839960,"5332.416666666667"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apiserver-9b6c5cc68-rtlwv"},"values":[[1546839600,"5094.968249470824"],[1546839720,"6639.916666666667"],[1546839840,"5537"],[1546839960,"7977.45"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-flannel-ds-gkqz5"},"values":[[1546839600,"26236.220603676727"],[1546839720,"55876.566666666666"],[1546839840,"25821.116666666665"],[1546839960,"32971.21666666667"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-proxy-gt84w"},"values":[[1546839600,"23729.145485758094"],[1546839720,"59712.73333333333"],[1546839840,"26693.033333333333"],[1546839960,"35146.05"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kubesphere-router-kubesphere-system-f9dbc8db4-bzbrb"},"values":[[1546839600,"762.6127102118369"],[1546839720,"25053.05"],[1546839840,"1995.6166666666666"],[1546839960,"4504.95"]]},{"metric":{"node":"i-5xcldxos","resource_name":"node-exporter-dtcrg"},"values":[[1546839600,"26518.575309588494"],[1546839720,"57161.683333333334"],[1546839840,"28838.433333333334"],[1546839960,"32257.616666666665"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-6k3cd"},"values":[[1546839600,"74.26790446507441"],[1546839720,"0"],[1546839840,"0"],[1546839960,"7.5"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-8sjg1"},"values":[[1546839600,"0"],[1546839720,"0"],[1546839840,"0"],[1546839960,"0"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-9dtns"},"values":[[1546839600,"72.56787613126885"],[1546839720,"6"],[1546839840,"0"],[1546839960,"5.1"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-kmr64"},"values":[[1546839600,"0"],[1546839720,"69.86666666666666"],[1546839840,"7.3"],[1546839960,"0"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-p8dlz"},"values":[[1546839600,"0"],[1546839720,"0"],[1546839840,"3.6"],[1546839960,"0"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-db-deployment-5bf97898d6-rpmlq"},"values":[[1546839600,"4128.0688011466855"],[1546839720,"5620.166666666667"],[1546839840,"4521.5"],[1546839960,"4854.783333333334"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-etcd-deployment-644b87df45-r5b9g"},"values":[[1546839600,"418.523642060701"],[1546839720,"414.81666666666666"],[1546839840,"460.1"],[1546839960,"435.75"]]},{"metric":{"node":"i-5xcldxos","resource_name":"wordpress-test-mariadb-0"},"values":[[1546839600,"4665.3777562959385"],[1546839720,"4318.7"],[1546839840,"5266"],[1546839960,"5754.25"]]}],"resultType":"matrix"}},{"metric_name":"pod_cpu_usage","status":"success","data":{"result":[{"metric":{"node":"i-5xcldxos","resource_name":"csi-qingcloud-node-q7np4"},"values":[[1546839600,"0.0000076419606993537"],[1546839720,"0.000009821283333303713"],[1546839840,"0.000009836300000013823"],[1546839960,"0.000011239300000013645"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-9x7kr"},"values":[[1546839600,"0.00009661484358069848"],[1546839720,"0.00008606121666664043"],[1546839840,"0.00007450641666674566"],[1546839960,"0.00010829649999995657"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-zcrw8"},"values":[[1546839600,"0.001136708695145068"],[1546839720,"0.0008391748999997617"],[1546839840,"0.0009679988166671668"],[1546839960,"0.0011175545499999848"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apigateway-6d9d4889bb-8d5wc"},"values":[[1546839600,"0.00022348539142321908"],[1546839720,"0.0009512427166666744"],[1546839840,"0.0011256540000000351"],[1546839960,"0.0035448391499999826"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apiserver-9b6c5cc68-rtlwv"},"values":[[1546839600,"0.006895327555455038"],[1546839720,"0.007528449566658916"],[1546839840,"0.006692454700002296"],[1546839960,"0.009126685333330897"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-flannel-ds-gkqz5"},"values":[[1546839600,"0.003207103101713859"],[1546839720,"0.0038445000166651274"],[1546839840,"0.0040174282333358255"],[1546839960,"0.003545626683330738"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-proxy-gt84w"},"values":[[1546839600,"0.01788103663393024"],[1546839720,"0.018504746333352765"],[1546839840,"0.01778927011664564"],[1546839960,"0.017722949649972484"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kubesphere-router-kubesphere-system-f9dbc8db4-bzbrb"},"values":[[1546839600,"0.0035628707478480696"],[1546839720,"0.016608661866666808"],[1546839840,"0.0034614630999991883"],[1546839960,"0.0038762507499995992"]]},{"metric":{"node":"i-5xcldxos","resource_name":"node-exporter-dtcrg"},"values":[[1546839600,"0.0015220510341843034"],[1546839720,"0.0007867750833340163"],[1546839840,"0.0016279568500002265"],[1546839960,"0.001446698416665863"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-6k3cd"},"values":[[1546839600,"0.009271150235837234"],[1546839720,"0.00890013696666756"],[1546839840,"0.00968312118333472"],[1546839960,"0.009171151599999424"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-8sjg1"},"values":[[1546839600,"0.011048380073003475"],[1546839720,"0.013485850099990178"],[1546839840,"0.01297967846666476"],[1546839960,"0.012453926949994334"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-9dtns"},"values":[[1546839600,"0.00916952009200656"],[1546839720,"0.009452597816668155"],[1546839840,"0.00891123176666421"],[1546839960,"0.00827908278333022"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-kmr64"},"values":[[1546839600,"0.009204036600613332"],[1546839720,"0.009940780150001653"],[1546839840,"0.009338642866669035"],[1546839960,"0.008951846800001325"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-p8dlz"},"values":[[1546839600,"0.014194345372421983"],[1546839720,"0.013538227316659383"],[1546839840,"0.012145717316661829"],[1546839960,"0.013020262316664836"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-db-deployment-5bf97898d6-rpmlq"},"values":[[1546839600,"0.014684090801507706"],[1546839720,"0.01593555808334107"],[1546839840,"0.017814800700004223"],[1546839960,"0.013949153216678193"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-etcd-deployment-644b87df45-r5b9g"},"values":[[1546839600,"0.006262018866983417"],[1546839720,"0.004479064850003548"],[1546839840,"0.0046167839833287875"],[1546839960,"0.006097170333335574"]]},{"metric":{"node":"i-5xcldxos","resource_name":"wordpress-test-mariadb-0"},"values":[[1546839600,"0.0028439593159849032"],[1546839720,"0.003771961066665123"],[1546839840,"0.0036304444000052173"],[1546839960,"0.0031916389833365126"]]}],"resultType":"matrix"}},{"metric_name":"pod_memory_usage","status":"success","data":{"result":[{"metric":{"node":"i-5xcldxos","resource_name":"csi-qingcloud-node-q7np4"},"values":[[1546839600,"30351360"],[1546839720,"30310400"],[1546839840,"30343168"],[1546839960,"30351360"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-9x7kr"},"values":[[1546839600,"16723968"],[1546839720,"16723968"],[1546839840,"16723968"],[1546839960,"16723968"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-zcrw8"},"values":[[1546839600,"50728960"],[1546839720,"50761728"],[1546839840,"50782208"],[1546839960,"50806784"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apigateway-6d9d4889bb-8d5wc"},"values":[[1546839600,"17866752"],[1546839720,"17940480"],[1546839840,"18464768"],[1546839960,"20398080"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apiserver-9b6c5cc68-rtlwv"},"values":[[1546839600,"78204928"],[1546839720,"77619200"],[1546839840,"78680064"],[1546839960,"79089664"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-flannel-ds-gkqz5"},"values":[[1546839600,"39800832"],[1546839720,"39800832"],[1546839840,"39727104"],[1546839960,"39608320"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-proxy-gt84w"},"values":[[1546839600,"116670464"],[1546839720,"116686848"],[1546839840,"116703232"],[1546839960,"116711424"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kubesphere-router-kubesphere-system-f9dbc8db4-bzbrb"},"values":[[1546839600,"160919552"],[1546839720,"162951168"],[1546839840,"162443264"],[1546839960,"163868672"]]},{"metric":{"node":"i-5xcldxos","resource_name":"node-exporter-dtcrg"},"values":[[1546839600,"46718976"],[1546839720,"46972928"],[1546839840,"46972928"],[1546839960,"46800896"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-6k3cd"},"values":[[1546839600,"1052561408"],[1546839720,"1052397568"],[1546839840,"1052405760"],[1546839960,"1052438528"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-8sjg1"},"values":[[1546839600,"562978816"],[1546839720,"562978816"],[1546839840,"562995200"],[1546839960,"562946048"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-9dtns"},"values":[[1546839600,"718286848"],[1546839720,"718233600"],[1546839840,"718258176"],[1546839960,"718286848"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-kmr64"},"values":[[1546839600,"470605824"],[1546839720,"470683648"],[1546839840,"470671360"],[1546839960,"470564864"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-p8dlz"},"values":[[1546839600,"717508608"],[1546839720,"717520896"],[1546839840,"717639680"],[1546839960,"717418496"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-db-deployment-5bf97898d6-rpmlq"},"values":[[1546839600,"838848512"],[1546839720,"838832128"],[1546839840,"838840320"],[1546839960,"838742016"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-etcd-deployment-644b87df45-r5b9g"},"values":[[1546839600,"51675136"],[1546839720,"51683328"],[1546839840,"51683328"],[1546839960,"51683328"]]},{"metric":{"node":"i-5xcldxos","resource_name":"wordpress-test-mariadb-0"},"values":[[1546839600,"145252352"],[1546839720,"145256448"],[1546839840,"145260544"],[1546839960,"145256448"]]}],"resultType":"matrix"}},{"metric_name":"pod_memory_usage_wo_cache","status":"success","data":{"result":[{"metric":{"node":"i-5xcldxos","resource_name":"csi-qingcloud-node-q7np4"},"values":[[1546839600,"9392128"],[1546839720,"9351168"],[1546839840,"9383936"],[1546839960,"9392128"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-9x7kr"},"values":[[1546839600,"7622656"],[1546839720,"7622656"],[1546839840,"7622656"],[1546839960,"7622656"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-zcrw8"},"values":[[1546839600,"38047744"],[1546839720,"38080512"],[1546839840,"38100992"],[1546839960,"38125568"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apigateway-6d9d4889bb-8d5wc"},"values":[[1546839600,"16400384"],[1546839720,"16474112"],[1546839840,"16998400"],[1546839960,"18931712"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apiserver-9b6c5cc68-rtlwv"},"values":[[1546839600,"77664256"],[1546839720,"77078528"],[1546839840,"78139392"],[1546839960,"78548992"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-flannel-ds-gkqz5"},"values":[[1546839600,"15552512"],[1546839720,"15552512"],[1546839840,"15478784"],[1546839960,"15360000"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-proxy-gt84w"},"values":[[1546839600,"48726016"],[1546839720,"48742400"],[1546839840,"48758784"],[1546839960,"48766976"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kubesphere-router-kubesphere-system-f9dbc8db4-bzbrb"},"values":[[1546839600,"108519424"],[1546839720,"110551040"],[1546839840,"110043136"],[1546839960,"111468544"]]},{"metric":{"node":"i-5xcldxos","resource_name":"node-exporter-dtcrg"},"values":[[1546839600,"22003712"],[1546839720,"22257664"],[1546839840,"22257664"],[1546839960,"22085632"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-6k3cd"},"values":[[1546839600,"353107968"],[1546839720,"352944128"],[1546839840,"352952320"],[1546839960,"352985088"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-8sjg1"},"values":[[1546839600,"280596480"],[1546839720,"280596480"],[1546839840,"280612864"],[1546839960,"280563712"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-9dtns"},"values":[[1546839600,"327921664"],[1546839720,"327868416"],[1546839840,"327892992"],[1546839960,"327921664"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-kmr64"},"values":[[1546839600,"236404736"],[1546839720,"236482560"],[1546839840,"236470272"],[1546839960,"236363776"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-p8dlz"},"values":[[1546839600,"295813120"],[1546839720,"295825408"],[1546839840,"295944192"],[1546839960,"295723008"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-db-deployment-5bf97898d6-rpmlq"},"values":[[1546839600,"502308864"],[1546839720,"502202368"],[1546839840,"502366208"],[1546839960,"502239232"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-etcd-deployment-644b87df45-r5b9g"},"values":[[1546839600,"21430272"],[1546839720,"21438464"],[1546839840,"21438464"],[1546839960,"21438464"]]},{"metric":{"node":"i-5xcldxos","resource_name":"wordpress-test-mariadb-0"},"values":[[1546839600,"112893952"],[1546839720,"112898048"],[1546839840,"112902144"],[1546839960,"112898048"]]}],"resultType":"matrix"}},{"metric_name":"pod_net_bytes_received","status":"success","data":{"result":[{"metric":{"node":"i-5xcldxos","resource_name":"csi-qingcloud-node-q7np4"},"values":[[1546839600,"42537.30895514925"],[1546839720,"60961.1"],[1546839840,"47361.333333333336"],[1546839960,"49697.36666666667"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-9x7kr"},"values":[[1546839600,"0"],[1546839720,"0"],[1546839840,"0"],[1546839960,"0"]]},{"metric":{"node":"i-5xcldxos","resource_name":"fluent-bit-zcrw8"},"values":[[1546839600,"2177.086284771413"],[1546839720,"2079.983333333333"],[1546839840,"1731.9166666666667"],[1546839960,"1278.2166666666667"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apigateway-6d9d4889bb-8d5wc"},"values":[[1546839600,"149.8524975416257"],[1546839720,"1915.2833333333333"],[1546839840,"962.3"],[1546839960,"5629.75"]]},{"metric":{"node":"i-5xcldxos","resource_name":"ks-apiserver-9b6c5cc68-rtlwv"},"values":[[1546839600,"19949.315821930366"],[1546839720,"21226.716666666667"],[1546839840,"19621.666666666668"],[1546839960,"22235.083333333332"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-flannel-ds-gkqz5"},"values":[[1546839600,"37729.27882131369"],[1546839720,"68868.3"],[1546839840,"37806.933333333334"],[1546839960,"49552.63333333333"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kube-proxy-gt84w"},"values":[[1546839600,"32699.01165019417"],[1546839720,"74924.4"],[1546839840,"42961.933333333334"],[1546839960,"55913.566666666666"]]},{"metric":{"node":"i-5xcldxos","resource_name":"kubesphere-router-kubesphere-system-f9dbc8db4-bzbrb"},"values":[[1546839600,"563.8427307121785"],[1546839720,"25045.616666666665"],[1546839840,"2106.266666666667"],[1546839960,"6646.116666666667"]]},{"metric":{"node":"i-5xcldxos","resource_name":"node-exporter-dtcrg"},"values":[[1546839600,"38190.703178386306"],[1546839720,"70471.81666666667"],[1546839840,"45780.833333333336"],[1546839960,"48935.5"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-6k3cd"},"values":[[1546839600,"134.20223670394506"],[1546839720,"0"],[1546839840,"0"],[1546839960,"63.266666666666666"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-8sjg1"},"values":[[1546839600,"0"],[1546839720,"0"],[1546839840,"0"],[1546839960,"0"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-9dtns"},"values":[[1546839600,"78.73464557742629"],[1546839720,"62.166666666666664"],[1546839840,"0"],[1546839960,"60.36666666666667"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-kmr64"},"values":[[1546839600,"0"],[1546839720,"74.93333333333334"],[1546839840,"63.266666666666666"],[1546839960,"0"]]},{"metric":{"node":"i-5xcldxos","resource_name":"nodejs-p8dlz"},"values":[[1546839600,"0"],[1546839720,"0"],[1546839840,"61.06666666666667"],[1546839960,"0"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-db-deployment-5bf97898d6-rpmlq"},"values":[[1546839600,"4409.7234953915895"],[1546839720,"4705.683333333333"],[1546839840,"4581.2"],[1546839960,"4522.2"]]},{"metric":{"node":"i-5xcldxos","resource_name":"openpitrix-etcd-deployment-644b87df45-r5b9g"},"values":[[1546839600,"408.4568076134602"],[1546839720,"406.95"],[1546839840,"448.81666666666666"],[1546839960,"423.3666666666667"]]},{"metric":{"node":"i-5xcldxos","resource_name":"wordpress-test-mariadb-0"},"values":[[1546839600,"414.706911781863"],[1546839720,"373.5"],[1546839840,"455.1"],[1546839960,"511.9"]]}],"resultType":"matrix"}}]}`
			res := GetResourceTimeSeriesMetric(metricStr, "pod_net_bytes_transmitted")
			fmt.Println(res)
		})
	})
}
